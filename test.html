<!DOCTYPE html>
<html>
    <body>
        <span data-adom-id="0">
            <div data-adom-id="1">
                matt
            </div>
        </span>
        <span data-adom-id="0">
            <div data-adom-id="2">
                mike
            </div>
        </span>
        <span data-adom-id="0">
            <div data-adom-id="3">
                jon
            </div>
        </span>
        <div data-adom-id="4">
            count: 0
        </div>
        <button onclick="increment()">
            increment
        </button>
    </body>
    <script>
    let nodes = [{"type":"tag","name":"span","children":[{"type":"tag","name":"div","children":[{"type":"textnode","chunks":[" ",["p"]," "],"store_ref":false,"is_only_child":true}],"classes":[],"attributes":{"data-adom-id":3},"events":[],"store_ref":true,"chunks":[" ",["p"]," "],"ref":3}],"classes":[],"attributes":{"data-adom-id":0},"each":{"iterator":"p","object":["people"]},"events":[],"store_ref":true,"ref":0},{"type":"tag","name":"div","children":[{"type":"textnode","chunks":[" ",["p"]," "],"store_ref":false,"is_only_child":true}],"classes":[],"attributes":{"data-adom-id":3},"events":[],"store_ref":true,"chunks":[" ",["p"]," "],"ref":3},{"type":"tag","name":"div","children":[{"type":"textnode","chunks":[" count: ",["count"]," "],"store_ref":false,"is_only_child":true}],"classes":[],"attributes":{"data-adom-id":4},"events":[],"store_ref":true,"chunks":[" count: ",["count"]," "],"ref":4}]
    let adom = {
    	state: {"count":0,"people":["matt","mike","jon"]},
    	update: function (obj) {
    		Object.assign(adom.state, obj)
    		
    		function get_value(v) {
    		  if (!Array.isArray(v)) return v
    		  v1 = adom.state
    		  for (let i = 0; i < v.length; i++) {
    		    if (typeof v1[i] !== undefined) {
    		      v1 = v1[v[i]] 
    		    } else {
    		      return undefined
    		    }
    		  }
    		  return v1
    		}
    		
    		nodes.forEach(function (n) {
    		  if (n.store_ref !== true)
    		    return
    		  let el = document.querySelector('[data-adom-id="' + n.ref + '"]')
    		  if (n.attributes) {
    		    Object.keys(n.attributes).forEach(function (k) {
    		      if (Array.isArray(n.attributes[k])) {
    			let v = get_value(n.attributes[k])
    			if (v !== undefined) {
    			  el.setAttribute(k, get_value(n.attributes[k]))
    			}
    		      }
    		    })
    		  }
    		  if (n.chunks) {
    		    let val = []
    		    for (let i = 0; i < n.chunks.length; i++) {
    		      let v = get_value(n.chunks[i])
    		      if (v !== undefined) {
    			val.push(v)	
    		      } else {
    			return
    		      }
    		    }
    		    el.textContent = val.join('').trim()
    		  }
    		})
    		
    	}
    }
    
    function increment () {
      adom.update({ count: adom.state.count + 1 })
    }
    
    </script>
</html>
