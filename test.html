<!DOCTYPE html>

<html lang='en'>
  	<head>
    	<script>
		window.onload = function () {
			let state = {
				items: [
					'walk dog',
					'eat dog'
				],
				nums: [1, 2, 3]
			}

			function $$id (id, all) {
				let a = document.querySelectorAll('[data-adom-id="' + id + '"]')
				return all ? a : a[0]
			}

			function $$setAttributes(e, attr) {
				Object.keys(attr).forEach(function (a) {
					e.setAttribute(a, attr[a])
				})
			}

			$$lengths = [2, 2]

			function $$each (list, fn) {
				let elements = []
				// handle objects differently
				list.forEach(function (item, i) {
					let children = fn(item, i)
					children.forEach(function (child) {
						if (Array.isArray(child)) {
							child.forEach(function (c) {
								elements.push(c)
							})
						} else {
							elements.push(child)
						}
					})
				})
				return elements
			}

			function $$el (tag, attributes, children) {
				if (tag === 'text') {
					return { type: 'text', text: attributes }
				}
				let els = []
				children.forEach(function (child) {
					if (Array.isArray(child)) {
						child.forEach(function (c) {
							els.push(c)
						})
					} else {
						els.push(child)
					}
				})
				return {
					type: 'node',
					name: tag,
					attributes: attributes,
					children: els
				}
			}

			function $$insertAtIndex (child, par, index) {
				if (index >= par.childNodes.length) {
					par.appendChild(child)
				} else {
					par.insertBefore(child, par.childNodes[index])
				}
			}

			function $$insertFrag (elements, par, index, lidx) {
				let frag = document.createDocumentFragment()
				let prevLen = $$lengths[lidx]

				function walk (elements, par, domPtr) {
					elements.forEach(function (el) {
						let e 

						if (el.type === 'text') {
							e = document.createTextNode(el.text)
						} else {
							e = document.createElement(el.name)
							$$setAttributes(e, el.attributes)
							if (el.children.length) {
								walk(el.children, e)
							}
						}
						par.appendChild(e)
					})
				}

				walk(elements, frag, par.childNodes[index])

				for (let i = index; i < (index + prevLen); i++) {
					par.removeChild(par.childNodes[index])
				}

				$$insertAtIndex(frag, par, index)

				return ($$lengths[lidx] = elements.length)
			}

			function $sync () {
				$$id('1').childNodes[0].nodeValue = 'Items remaining: ' + state.items.length

				let frag1 = $$each(state.items, function (i) {
					return [
						$$el('li', { 'data-adom-id': '3' }, [
							$$el('text', i)
						])
					]
				})

				let offs1 = $$insertFrag(frag1, $$id('2'), 0, 0)

				let frag2 = $$each(state.items, function (i) {
					return [
						$$el('li', { 'data-adom-id': '4' }, [
							$$el('text', i),
							$$each(state.nums, function (i) {
								return [
									$$el('span', {}, [
										$$el('text', i)
									])
								]
							})
						])
					]
				})

				let offs2 = $$insertFrag(frag2, $$id('2'), offs1 + 2, 1)
			}

			/*
				div
					div [
						h1 | MATTS TODO LIST |
						p | Items remaining: {items.length} |
					]
					div [
						ul [
							each (i in items) [
								li | {i} |
							]
							li | MIDDLE |
							li | MIDDLE 2 |
							each (i in items) [
								li | {i} |
								each (i in [1, 2, 3]) [
									span | {i} |
								]
							]
						]
					]
				]
			*/

			window.btn.addEventListener('click', function () {
				state.nums.push(1)
				state.items.push('new item')
				$sync()
			})
		}
		</script>
	</head>
	<body>
		<div id='main'>
			<div>
				<h1>MATTS TODO LIST</h1>
				<p data-adom-id='1'>Items reamining: 2</p>
			</div>
			<div>
				<ul data-adom-id='2'><li data-adom-id='3'>walk dog</li><li data-adom-id='3'>eat dog</li><li>MIDDLE</li><li>MIDDLE 2</li><li data-adom-id='4'>walk dog</li><li data-adom-id='4'>eat dog</li></ul>
			</div>
		</div>
		<button id="btn">sync</button>
	</body>
</html>
