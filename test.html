<!DOCTYPE html>
<html>
    <body class="fish butt">
        <h1 data-adom-id="0">
            TODO APP
        </h1>
        <input id="item" />
        <br />
        <button onclick="addItem()">
            ADD ITEM
        </button>
        <ul>
            <li data-adom-id="1">
                buy milk
            </li>
            <li data-adom-id="1">
                buy sausage
            </li>
            <li data-adom-id="1">
                buy mounds bar
            </li>
        </ul>
        <div data-adom-id="2">
            count: 3
        </div>
        <p data-adom-id="3">
            hello matt
        </p>
    </body>
    <script>
    let nodes = [{"type":"tag","name":"h1","children":[{"type":"textcontent","chunks":[" TODO APP "],"store_ref":false,"is_only_child":true}],"attributes":{"data-adom-id":0},"classes":[],"store_ref":true,"chunks":[" TODO APP "],"ref":0,"events":[]},{"type":"tag","name":"li","children":[{"type":"textcontent","chunks":[" ",["i"]," "],"store_ref":false,"is_only_child":true}],"attributes":{"data-adom-id":1},"classes":[],"store_ref":true,"chunks":[" ",["i"]," "],"ref":1,"each":{"iterator":["i"],"list":["items"]},"events":[]},{"type":"tag","name":"div","children":[{"type":"textcontent","chunks":[" count: ",["items","length"]," "],"store_ref":false,"is_only_child":true}],"attributes":{"data-adom-id":2},"classes":[],"store_ref":true,"chunks":[" count: ",["items","length"]," "],"ref":2,"events":[]},{"type":"tag","name":"p","children":[{"type":"textcontent","chunks":[" hello ",["name"]," "],"store_ref":false,"is_only_child":true}],"attributes":{"data-adom-id":3},"classes":[],"store_ref":true,"chunks":[" hello ",["name"]," "],"ref":3,"condition":{"lhs":["name"],"rhs":"matt","cmp":"eq"},"events":[]}]
    
    
    function evaluate_condition (condition) {
        let lhs = get_value(condition.lhs)
        let rhs = get_value(condition.rhs)
    
        switch (condition.cmp) {
          case 'eq':
    	if (lhs == rhs) return true
    	return false
          case 'ne':
    	if (lhs != rhs) return true
    	return false
          case 'le':
    	if (lhs <= rhs) return true
    	return false
          case 'ge':
    	if (lhs >= rhs) return true
    	return false
          case 'lt':
    	if (lhs < rhs) return true
    	return false
          case 'gt':
    	if (lhs > rhs) return true
    	return false
          default:
    	break
        }
        return false
      }
    
    function get_value(v) {
      if (!Array.isArray(v)) return v
      let idx = adom._state.length - 1
      let check = v[0]
      while (adom._state[idx][check] == null && idx > 0) {
        idx--
      }
      v1 = adom._state[idx]
      for (let i = 0; i < v.length; i++) {
        if (typeof v1[i] !== undefined) {
          v1 = v1[v[i]] 
        } else {
          return undefined
        }
      }
      return v1
    }
    
    function update_attributes (el, attr) {
      Object.keys(attr).forEach(function (k) {
        if (Array.isArray(attr[k])) {
          let v = get_value(attr[k])
          if (v !== undefined) {
    	el.setAttribute(k, get_value(attr[k]))
          }
        }
      })
    }
    
    function update_textcontent (el, chunks) {
      let val = []
      for (let i = 0; i < chunks.length; i++) {
        let v = get_value(chunks[i])
        if (v !== undefined) {
          val.push(v)	
        } else {
          return
        }
      }
      el.textContent = val.join('').trim()
    }
    
    function execute_loop (el, node) {
      let arr = get_value(node.each.list)
      let it = node.each.iterator
      let frag = document.createDocumentFragment()
      if (arr.length > 0) 
        el.hidden = false
      arr.forEach(function (i) {
        let e = el.cloneNode(true)
        adom._state.push({ [it]: i })
        update_node(e, node)
        if (node.children)
          update_children(e, node.children)
        frag.append(e)
        adom._state.pop()
      })
      el.replaceWith(frag)
    }
    
    function update_node (el, n) {
      if (n.attributes) {
        update_attributes(el, n.attributes)
      }
      if (n.condition) {
        if (evaluate_condition(n.condition)) {
          el.hidden = false
        } else {
          el.hidden = true
        }
      }
      if (n.chunks) {
        update_textcontent(el, n.chunks)
      }
    }
    
    function update_children (par, children) {
      children.forEach(function (n) {
        if (n.store_ref !== true) {
          return
        }
        let el = par.querySelector('[data-adom-id="' + n.ref + '"]')
        if (n.each) {
          let elList = par.querySelectorAll('[data-adom-id="' + n.ref + '"]')
          for (let i = 1; i < elList.length; i++) {
    	elList[i].parentNode.removeChild(elList[i])
          }
          execute_loop(el, n)
        } else {
          update_node(el, n)
        }
      })
    }
    
    let adom = {
    	_state: [{"items":["buy milk","buy sausage","buy mounds bar"],"name":"matt","people":[null,null,null,"matt"]}],
    	update: function (obj) {
    		Object.assign(adom._state[0], obj)
    		update_children(document, nodes)
    	}
    }
    adom.state = adom._state[0]
    
      function addItem () {
        let items = adom.state.items
        let el = document.getElementById('item')
      
        items.push(el.value)
        adom.update({ items: items })
        el.value = ''
      }</script>
</html>
